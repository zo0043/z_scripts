# Linux.do 文章助手

一个功能强大的油猴脚本，为 Linux.do 网站提供智能文章匹配、批量打开、状态机驱动的自动滚动和快捷键控制功能。

## 🚀 核心特性

### 🧠 智能页面检测
- **自动识别**: 智能检测当前页面类型（帖子详情页、文章列表页、其他页面）
- **自适应界面**: 根据页面类型自动调整控制面板功能
- **功能切换**: 列表页专注于文章匹配，帖子页专注于阅读体验

### ⚡ 状态机驱动滚动系统
- **四态状态机**: STOPPED（停止）→ SCROLLING（滚动）→ PAUSED（暂停）→ ERROR（错误）
- **智能状态转换**: 严格的状态转换规则，防止非法操作
- **用户行为感知**: 向上滚动自动暂停，向下滚动自动恢复
- **防竞态条件**: 状态转换锁定机制，确保系统稳定性
- **自动恢复**: 错误状态自动恢复到安全状态

### 🎯 高级关键词匹配
- **多模式匹配**: 支持包含匹配和精确匹配
- **实时高亮**: 匹配文章自动高亮显示
- **智能过滤**: 防重复打开，已读文章自动过滤
- **批量处理**: 支持批量打开匹配文章

### ⌨️ 完整快捷键系统
- **Ctrl+E**: 开启/关闭自动滚动
- **Ctrl+S**: 暂停/恢复自动滚动
- **Ctrl+R**: 回到顶部
- **Ctrl+B**: 滚动到底部
- **智能屏蔽**: 输入框中自动禁用快捷键

### 🔄 智能滚动控制
- **随机间隔**: 100ms-1000ms随机滚动间隔，模拟自然阅读
- **距离可调**: 每次滚动距离100-1000像素可配置
- **底部检测**: 精确检测页面底部，自动询问是否回到顶部
- **平滑动画**: 使用CSS平滑滚动，提供最佳阅读体验

### 📊 完整状态管理
- **统一状态源**: AppState集中管理所有应用状态
- **持久化配置**: 所有配置自动保存到本地存储
- **状态一致性**: 多重状态同步机制，确保数据一致性
- **防重复机制**: URL去重和窗口数量限制

### 🎛️ 响应式控制面板
- **拖拽定位**: 支持鼠标拖拽移动面板位置
- **动态内容**: 根据页面类型动态生成控制界面
- **实时状态**: 实时显示滚动状态、窗口计数等信息
- **优雅动画**: 平滑的显示/隐藏动画效果

### 🛡️ 错误处理与恢复
- **异常捕获**: 完善的错误捕获和日志记录
- **状态重置**: 支持强制重置到安全状态
- **用户友好**: 详细的错误提示和解决建议
- **自动恢复**: 大多数错误可自动恢复

## 📦 安装方法

### 1. 安装油泼猴扩展
- Chrome: [Tampermonkey](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
- Firefox: [Tampermonkey](https://addons.mozilla.org/firefox/addon/tampermonkey/)
- Edge: [Tampermonkey](https://microsoftedge.microsoft.com/addons/detail/tampermonkey/iikmkjmpaadaobahmlepeloendndfphd)

### 2. 导入脚本
1. 下载 `linux-do-article-helper.user.js` 文件
2. 打开油泼猴管理面板
3. 点击"实用工具" → "从文件安装"
4. 选择下载的脚本文件
5. 确认安装

## 🎮 使用指南

### 📄 页面类型与功能

#### 🔗 文章列表页（/latest, /categories, /top等）
**功能焦点：文章发现与批量处理**
1. 点击右上角 🐧 图标打开控制面板
2. 配置关键词列表（每行一个）
3. 选择匹配模式（包含/精确）
4. 点击"刷新文章列表"获取最新文章
5. 点击"打开匹配文章"批量打开相关文章
6. 可选：开启自动滚动持续发现新文章

#### 📖 帖子详情页（/t/topic/数字）
**功能焦点：智能阅读体验**
1. 打开控制面板（自动切换到帖子模式）
2. 配置滚动参数：
   - 滚动距离（100-1000像素）
   - 自动开始选项
3. 使用按钮或快捷键控制滚动
4. 系统智能检测您的滚动行为：
   - 向上滚动 → 自动暂停
   - 向下滚动 → 自动恢复

### ⌨️ 快捷键操作

| 快捷键 | 功能 | 适用页面 |
|--------|------|----------|
| **Ctrl+E** | 开启/关闭自动滚动 | 帖子页 |
| **Ctrl+S** | 暂停/恢复自动滚动 | 帖子页 |
| **Ctrl+R** | 回到顶部 | 帖子页 |
| **Ctrl+B** | 滚动到底部 | 帖子页 |

> 💡 **提示**: 快捷键在输入框中自动禁用，避免误触

### 🎯 关键词配置示例

```
AI
JavaScript
Python
机器学习
开发工具
开源项目
后端开发
前端框架
```

### ⚙️ 高级配置

#### 滚动参数（帖子页）
- **滚动距离**: 每次滚动的像素数（100-1000）
- **随机间隔**: 自动随机生成（100ms-1000ms），模拟自然阅读
- **自动开始**: 进入帖子页面时自动开始滚动

#### 匹配参数（列表页）
- **匹配模式**:
  - 包含匹配：标题包含关键词即匹配
  - 精确匹配：标题完全等于关键词才匹配
- **窗口限制**: 最大同时打开标签页数量（1-10）
- **防重复**: 自动过滤已打开的文章URL

### 🔄 智能滚动特性

#### 状态机行为
- **🟢 SCROLLING**: 自动滚动中，向下滚动保持状态
- **🟡 PAUSED**: 用户暂停，向上滚动触发，向下滚动恢复
- **🔴 STOPPED**: 手动停止或到达底部
- **🔴 ERROR**: 错误状态，自动恢复到STOPPED

#### 用户交互
- **向上滚动**: 系统检测到后自动暂停滚动
- **向下滚动**: 系统检测到后自动恢复滚动
- **到达底部**: 自动停止并询问是否回到顶部继续

### 📊 状态监控

控制面板实时显示：
- 📊 当前状态：就绪/滚动中/已暂停/错误
- 🪟 窗口计数：当前打开数/最大限制
- 📚 已打开文章：累计去重数量
- 👆 用户滚动：检测到的用户行为状态
- 🔄 滚动状态：当前状态机状态

### 🛠️ 管理功能

#### 窗口管理
- **重置窗口计数**: 清零当前打开的标签页计数
- **清空打开记录**: 清除已打开文章的URL历史

#### 配置管理
- **自动保存**: 所有配置修改即时保存
- **持久化**: 浏览器重启后配置保持不变
- **默认重置**: 一键恢复出厂设置

## ⚙️ 完整配置参数

### 📋 列表页面配置

| 配置项 | 默认值 | 说明 | 可选值 |
|--------|--------|------|--------|
| 关键词列表 | ['AI', 'JavaScript', 'Python', '编程', '开发'] | 要匹配的关键词数组 | 任意字符串数组 |
| 匹配模式 | contains | 标题匹配方式 | contains（包含）, exact（精确） |
| 最大标签页数 | 10 | 同时打开的标签页上限 | 1-10 |
| 启用通知 | true | 显示操作反馈通知 | true, false |
| 启用高亮 | true | 高亮匹配文章 | true, false |

### 📖 帖子页面配置

| 配置项 | 默认值 | 说明 | 范围 |
|--------|--------|------|------|
| 自动开始滚动 | false | 进入页面时自动开始滚动 | true, false |
| 滚动距离 | 300px | 每次向下滚动的像素数 | 100-1000 |
| 随机间隔范围 | 100-1000ms | 滚动间隔的随机范围 | 固定范围 |

## 🏗️ 技术架构

### 模块化设计
脚本采用严格的模块化架构，每个模块职责单一且高内聚：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   AppState      │    │  PageDetector   │    │ TopicScroller   │
│  (状态管理)     │    │  (页面检测)     │    │ (滚动控制器)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
    │  DataFetcher    │    │ KeywordMatcher  │    │   TabManager    │
    │  (数据获取)     │    │ (关键词匹配)    │    │ (标签页管理)    │
    └─────────────────┘    └─────────────────┘    └─────────────────┘
                                 │
    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
    │KeyboardManager  │    │  ControlPanel   │    │    用户界面     │
    │ (快捷键管理)    │    │  (UI控制器)     │    │                 │
    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 🔄 状态机核心
TopicScroller实现了复杂的状态机系统：

```javascript
// 状态转换规则（示例）
STOPPED ──用户启动──→ SCROLLING
  ↑                      ↓
  └──── 到达底部 ──────┘
SCROLLING ──用户向上滚动──→ PAUSED
   ↓                      ↑
   └──用户向下滚动──┘
PAUSED ──用户停止──→ STOPPED
任何状态 ──错误发生──→ ERROR ──自动恢复──→ STOPPED
```

### 🧠 内存管理
- **防内存泄漏**: 递归调度包含最大迭代次数限制
- **定时器管理**: 页面卸载时自动清理所有定时器
- **事件监听器**: 统一绑定和解绑机制
- **状态缓存**: 智能缓存避免重复DOM查询

### ⚡ 性能优化
- **防抖节流**: 滚动事件使用50ms节流+30ms防抖
- **异步处理**: 所有UI更新使用requestAnimationFrame
- **批量DOM操作**: 减少重排和重绘
- **惰性加载**: 按需初始化功能模块

### 🛡️ 安全机制
- **状态验证**: 严格的状态一致性检查
- **边界检测**: 防止滚动越界
- **异常恢复**: 多层次错误处理机制
- **用户保护**: 输入框自动屏蔽快捷键

## 🔧 技术特性详解

### 智能页面检测算法
```javascript
// 页面类型检测逻辑
getPageType() {
    const url = window.location.href;
    if (url.includes('/t/') && /\d+/.test(url)) return 'topic';
    if (url.includes('/latest') || url.includes('/categories')) return 'list';
    return 'other';
}
```

### 随机化滚动算法
```javascript
// 100ms-1000ms 随机间隔，模拟自然阅读
getRandomDelay() {
    const minDelay = 100;
    const maxDelay = 1000;
    return Math.floor(Math.random() * (maxDelay - minDelay + 1)) + minDelay;
}
```

### 状态转换锁机制
- 防止快速连续的状态转换冲突
- 150ms转换锁定时间
- 待处理转换队列机制
- 自动解锁和错误恢复

## 🛠️ 故障排除

### 🔧 常见问题解决

#### ⚠️ 脚本无法正常工作
**排查步骤：**
1. **油猴扩展检查**: 确保Tampermonkey已正确安装并启用
2. **脚本状态**: 检查脚本是否处于启用状态（绿色开关）
3. **网站匹配**: 确认当前访问的是 `https://linux.do/*` 地址
4. **控制台检查**: 按F12打开开发者工具，查看Console错误信息

#### 📜 自动滚动异常
**可能原因及解决方案：**

| 症状 | 原因 | 解决方案 |
|------|------|----------|
| 滚动不启动 | 状态机错误 | 按Ctrl+E重新启动，或刷新页面 |
| 滚动不停 | 状态转换失败 | 按Ctrl+E强制停止，或关闭面板 |
| 滚动卡顿 | 页面性能问题 | 关闭其他标签页，降低滚动距离 |
| 快捷键失效 | 焦点在输入框 | 点击页面空白处，退出输入框 |

#### 🎯 关键词匹配失败
**检查清单：**
- 关键词格式正确（每行一个，无多余空格）
- 匹配模式设置正确（推荐使用"包含匹配"）
- 页面已完全加载（等待页面图标停止转动）

#### 🪟 标签页管理问题
**限制与解决方案：**
- **窗口上限**: 默认最大10个标签页，可在配置中调整
- **重复检测**: 已打开的文章URL不会重复打开
- **浏览器阻止**: 检查浏览器弹窗设置，允许linux.do打开弹窗

### 🔍 调试模式

#### 控制台命令
在浏览器开发者工具Console中输入：

```javascript
// 查看当前状态机状态
TopicScroller.getDebugInfo()

// 检查状态一致性
TopicScroller.checkStateConsistency()

// 查看应用状态
console.log(AppState.config)
```

#### 日志分析
脚本会在Console输出详细日志：
- 状态转换记录
- 滚动事件处理
- 错误信息和恢复过程

### 🔄 高级故障恢复

#### 强制重置状态机
如果状态机进入异常状态，可以：
1. 关闭控制面板
2. 刷新页面（F5）
3. 重新打开控制面板

#### 清理损坏的配置
如果配置损坏导致脚本异常：
1. 打开控制面板
2. 点击"重置窗口计数"
3. 点击"清空打开记录"
4. 刷新页面重新配置

### 📋 性能优化建议

#### 提升响应速度
- 关闭不必要的浏览器标签页
- 降低滚动距离设置（200-400px）
- 使用包含匹配而非精确匹配

#### 减少资源占用
- 及时清理已打开的标签页
- 定期清空打开记录
- 避免同时运行多个自动化脚本

## 📄 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个脚本！

## 📋 版本历史

### v3.0.0 (2024-10-29) - 重大架构重构
🏗️ **架构升级**:
- ✨ 实现状态机驱动的滚动控制系统
- 🧠 新增智能页面检测（帖子页/列表页自动识别）
- ⌨️ 完整快捷键系统（Ctrl+E/S/R/B）
- 🎛️ 响应式控制面板（根据页面类型动态调整）
- 🔄 随机化滚动间隔（100ms-1000ms）模拟自然阅读
- 🛡️ 强化的错误处理和状态恢复机制
- 📊 实时状态监控和一致性检查
- 🎯 用户行为感知滚动控制（向上暂停/向下恢复）

### v2.0.0 (2024-10-28) - 功能增强版
🚀 **核心功能**:
- ✨ 新增帖子页面自动滚动功能
- 🎛️ 可配置滚动距离和自动开始选项
- 📊 实时状态显示和监控
- 🛡️ 防重复打开机制完善
- 🎯 状态管理优化

### v1.3.0 (2024-10-28) - 防重复优化
🚫 **重复控制**:
- 🚫 新增防重复打开功能
- 📚 记录所有已打开文章的URL
- 🔍 智能过滤已打开过的文章
- 🗑️ 添加清空打开记录功能
- 📊 显示已打开文章数量统计
- 🛡️ 防止浏览器资源浪费

### v1.2.0 (2024-10-28) - 窗口管理
🪟 **资源控制**:
- 🪟 新增窗口计数限制功能 (最多10个窗口)
- 🚫 达到窗口上限时自动停止滚动
- 🔄 添加手动重置窗口计数器功能
- ⏱️ 优化打开延迟时间 (500ms→2000ms)
- 📊 实时显示窗口计数状态
- 🔧 增强的错误处理和用户反馈

### v1.1.0 (2024-10-28) - 历史记录
📚 **数据追踪**:
- ✨ 新增历史记录功能
- 📚 自动记录所有打开的文章信息
- 🔍 支持按来源筛选历史记录
- 🗑️ 支持单条删除和批量清空
- 📊 新增统计信息显示
- 🎯 优化自动打开功能体验

### v1.0.0 (2024-10-28) - 初始版本
🎉 **基础功能**:
- ✨ 初始版本发布
- 🎯 基础关键词匹配功能
- 📑 标签页并发控制
- 🎛️ 配置管理界面
- 📜 简单自动滚动控制
- 🔔 桌面通知支持

---

## 🔮 开发路线图

### 即将推出 (v3.1.0)
- 🎨 主题定制功能（深色/浅色模式）
- 📊 高级统计分析面板
- 🔍 正则表达式关键词支持
- 📱 移动端适配优化

### 未来计划 (v3.2.0+)
- 🤖 AI智能推荐算法
- 👥 多用户配置同步
- 📈 阅读习惯分析
- 🔗 与其他平台的集成

---

## 💡 使用技巧

### 🎯 高效使用建议
1. **列表页**: 使用通用关键词如"AI"、"JavaScript"获取广泛内容
2. **帖子页**: 调整滚动距离至200-400px获得最佳阅读体验
3. **快捷键**: 熟练使用Ctrl+E/S控制滚动，提升效率
4. **状态监控**: 观察面板状态信息，及时发现问题

### ⚡ 性能优化
- 定期清理已打开的标签页和记录
- 合理设置最大窗口数量（建议5-8个）
- 使用包含匹配提高匹配效率

---

## 🤝 贡献指南

### 报告问题
请在GitHub Issues中报告问题，并包含：
- 详细的错误描述
- 浏览器和版本信息
- 控制台错误日志
- 重现步骤

### 功能建议
欢迎提出新功能建议：
- 描述使用场景
- 说明功能价值
- 提供设计思路

### 代码贡献
1. Fork 项目仓库
2. 创建功能分支
3. 提交代码变更
4. 发起Pull Request

---

**🎉 感谢使用 Linux.do 文章助手！**

如果您觉得这个工具有用，请给项目一个⭐️，您的支持是我们持续改进的动力！